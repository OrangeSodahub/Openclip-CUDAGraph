## Openclip-CUDAGraph
Tips: There are three steps from the original model to final callable optimized model:
1. Trace the torch model through `torch.fx._symbolic_trace` to generate `torch.fx.GraphModuel` object.
2. Replace some modules in this object to optimize it **(not included in this version)** and output is a `torch.fx.GraphModuel` object.
3. Build static graph model through `torch.cuda.CUDAGraph`.
And also not use `torchdynamo.optimize()`.

### Benchmark

Tested on RTX3080:

It saves the time cost on starting the model multiply times. When N gets larger and batch_size gets smaller, it performs better.

<left class="half">
    <img src=./assets/1.png width=60%>
</left>


---------------------------------------------------------------------------------
times   |shape     | model                      | pt (s)   | graph (s)| speed up
--------|----------|----------------------------|----------|----------|----------
|1      |(1, 77)   |ViT-L-14::laion2b-s32b-b82k |0.0068    |1.1747    |0.00575
|       |(2, 77)   |                            |0.0073    |1.1755    |0.00605
|       |(4, 77)   |                            |0.0070    |1.1780    |0.00583
|       |(8, 77)   |                            |0.0071    |1.2095    |0.00575
|       |(16, 77)  |                            |0.0087    |1.1905    |0.00796
|       |(1, 3, 224, 224)|                      |0.0134    |3.9472    |
|       |(2, 3, 224, 224)|                      |0.0352    |4.0213    |
|       |(4, 3, 224, 224)|                      |0.0323    |4.0170    |
|       |(8, 3, 224, 224)|                      |0.0416    |4.1213    |
|100    |(1, 77)   |ViT-L-14::laion2b-s32b-b82k |0.0645    |1.4387    |0.44370
|       |(2, 77)   |                            |0.0749    |1.4735    |0.44843
|       |(4, 77)   |                            |0.0659    |1.5138    |0.43349
|       |(8, 77)   |                            |0.0672    |1.6625    |0.42214
|       |(16, 77)  |                            |0.0855    |2.1333    |0.37915
|       |(1, 3, 224, 224)|                      |0.1328    |3.9772    |-2894.45%
|       |(2, 3, 224, 224)|                      |0.1507    |4.0623    |-2594.21%
|       |(4, 3, 224, 224)|                      |0.3066    |4.2564    |-1288.65%
|       |(8, 3, 224, 224)|                      |0.3949    |4.4650    |-1030.98%
|1000   |(1, 77)   |ViT-L-14::laion2b-s32b-b82k |6.3198    |3.7619    |1.67443
|       |(2, 77)   |                            |6.5773    |4.1487    |1.55306
|       |(4, 77)   |                            |6.6337    |4.3992    |1.47605
|       |(8, 77)   |                            |6.7029    |5.7641    |1.13833
|       |(16, 77)  |                            |8.0548    |7.8367    |0.82446
|       |(1, 3, 224, 224)|                      |13.0253   |11.9307   |8.40%
|       |(2, 3, 224, 224)|                      |15.0432   |17.7647   |-18.09%
|       |(4, 3, 224, 224)|                      |-         |-         |-
|10000  |(1, 77)   |ViT-L-14::laion2b-s32b-b82k |63.0495   |18.0050   |3.50177
|       |(2, 77)   |                            |65.4867   |21.7872   |3.00574
|       |(4, 77)   |                            |64.9916   |24.3028   |2.67424
|       |(8, 77)   |                            |65.7108   |37.9319   |1.73254
|       |(16, 77)  |                            |81.8811   |77.0026   |1.06335
|       |(1, 3, 224, 224)|                      |-         |-         |
|       |(2, 3, 224, 224)|                      |-         |-         |
|       |(4, 3, 224, 224)|                      |-         |-         |

